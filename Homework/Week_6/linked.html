<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Linked views</title>

    <!-- Import D3 V5 -->
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script>
      d3v5 = d3;
      window.d3 = null;
    </script>

    <!-- Import D3 V3 and TopoJSON -->
    <script src="https://d3js.org/d3.v3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/1.6.9/topojson.min.js"></script>
    <script src="datamaps.world.min.js"></script>
    <script src="toCountryCode.js"></script>
    <script>
      d3v3 = d3;
      window.d3 = null;

      // Test if it worked
      console.log('v3', d3v3.version);
      console.log('v5', d3v5.version);
    </script>
    <div id="container" style="position: relative; width: 800px; height: 600px;"></div>
    <div id="pie"></div>
    <script>
    d3v5.json("data.json").then(function(datas) {

      console.log(datas)
      // Make a list with objects
      all_countries = {}
      for(var i = 0; i < 2196; i++){
        country = {}
        if(datas["fact"][i]["dims"]["SEX"] == "Both sexes" && datas["fact"][i]["dims"]["YEAR"] == 2016){
          value = datas["fact"][i]["Value"];
          if(value < 10){
            fillKey = "LOWER10";
          }
          else if (value > 10 && value < 20){
            fillKey = "TENT20";
          }
          else if(value > 20 && value < 30){
            fillKey = "TWENT30";
          }
          else if(value > 30){
            fillKey = "THIRM";
          }
          country["Value"] = datas["fact"][i]["Value"];
          country["fillKey"] = fillKey;
          country_name = datas["fact"][i]["dims"]["COUNTRY"];
          code = toCountryCode(country_name);

          // Also add seperated for Male and Female
          for(var j = 0; j < 2196; j++){
            // console.log(datas["fact"][j]["dims"]["Sex"]);
            // console.log(datas["fact"][j]["dims"]["YEAR"]);
            // console.log(datas["fact"][j]["dims"]["COUNTRY"]);

            if(datas["fact"][j]["dims"]["SEX"] == "Male" && datas["fact"][j]["dims"]["YEAR"] == 2016 && datas["fact"][j]["dims"]["COUNTRY"] == country_name){
              country["Male"] = datas["fact"][j]["Value"];
            }
            if(datas["fact"][j]["dims"]["SEX"] == "Female" && datas["fact"][j]["dims"]["YEAR"] == 2016 && datas["fact"][j]["dims"]["COUNTRY"] == country_name){
              country["Female"] = datas["fact"][j]["Value"];
            }
          }
          all_countries[code] = country;
        }
      }

      var map = new Datamap({
          element: document.getElementById('container'),
          fills: {
              LOWER10: '#cbc9e2',
              TENT20: '#9e9ac8',
              TWENT30: '#756bb1',
              THIRM: '#54278f',
              UNKNOWN: '#f2f0f7',
              defaultFill: '#f2f0f7'
          },
          data:
            all_countries,
          geographyConfig: {
            highlightBorderColor: '#bada55',
            popupTemplate: function(geography, data) {
              return '<div class="hoverinfo">' + geography.properties.name +
              ":" + " " + all_countries[(geography.id)]["Value"] + ' '
            },
            highlightBorderWidth: 3
          },
          done: function(datamap) {
            datamap.svg.selectAll('.datamaps-subunit').on('click', function(geography) {
                console.log(all_countries[(geography.id)]["Male"]);
                console.log(all_countries[(geography.id)]["Female"]);
                redraw([{"label": "Male", "value":all_countries[(geography.id)]["Male"]}, {"label": "Female", "value":all_countries[(geography.id)]["Female"]}]);
            });
          },

    });

      // Draw a legend for this map
      map.legend();

      // Make a pie chart
      var margin = {top: 100, bottom: 10, left: 10, right: 10},
        width = window.innerWidth - margin.left - margin.right,
        height = window.innerHeight - margin.top - margin.bottom,
        radius = Math.min(width, height) / 2;

      var svg = d3v5.select("body").append("svg")
          .attr("width", width + margin.left + margin.right)
          .attr("height", height + margin.top + margin.bottom)
        .append("g")
          .attr("transform", "translate(" + ((width / 2) + margin.left) + "," + ((height / 2) + margin.top) + ")");

      // Make a title
      svg.append("text")
        .attr("x", -100)
        .attr("y", -300)
        .text("Males and Females Suicide");

      var color = d3v5.scaleOrdinal(["#9ecae1", "#fa9fb5"])

      var pie = d3v5.pie()
          .sort(null)
          .value(function(d) { return d.value; });

      var arc = d3v5.arc()
          .outerRadius(radius)
          .innerRadius(0)

      redraw([{"label": "Male", "value":all_countries["BEN"]["Male"]}, {"label": "Female", "value":all_countries["BEN"]["Female"]}]);

      function redraw(data){

        // join
        var arcs = svg.selectAll(".arc")
            .data(pie(data), function(d){ return d.data.name; });

        // update
        arcs
          .transition()
            .duration(1500)
            .attrTween("d", arcTween);

        // enter
        arcs.enter().append("path")
          .attr("class", "arc")
          .attr("fill", function(d, i) { return color(i); })
          .attr("d", arc)
          .each(function(d) { this._current = d; });

        arcs.enter().append("text")                                     //add a label to each slice
                .attr("transform", function(d) {                    //set the label's origin to the center of the arc
                //we have to make sure to set these before calling arc.centroid
                d.innerRadius = 0;
                d.outerRadius = radius;
                return "translate(" + arc.centroid(d) + ")";        //this gives us a pair of coordinates like [50, 50]
              })
              .attr("text-anchor", "middle")                          //center the text on it's origin
              .text(function(d, i) { return data[i].label + ":" + " " + data[i].value; });        //get the label from our original data array

        // Remove if needed
        arcs.exit().remove();
      }

      // Store the displayed angles in _current.
      // Then, interpolate from _current to the new angles.
      // During the transition, _current is updated in-place by d3v3.interpolate.
      function arcTween(a) {
        console.log(this._current);
        var i = d3v5.interpolate(this._current, a);
        this._current = i(0);
        return function(t) {
          return arc(i(t));
        };
      }
    });
    </script>

    <!-- REST OF IMPORTS HERE -->

  </head>
  <body>

    <!-- CONTENT OF PAGE HERE -->

  </body>
</html>
